name: CD

on:
    workflow_run:
        workflows: [CI]
        types: [completed]
        branches: [main]

concurrency:
    group: cd-${{ github.ref }}
    cancel-in-progress: false

jobs:
    migrate:
        name: Migrate Database
        runs-on: ubuntu-latest
        environment: production
        if: ${{ github.event.workflow_run.conclusion == 'success' }}

        steps:
            - uses: actions/checkout@v4

            - uses: pnpm/action-setup@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: pnpm

            - run: pnpm install --frozen-lockfile

            - run: pnpm migrate
              env:
                  DATABASE_URL: ${{ secrets.DATABASE_URL }}
                  PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}

    deploy:
        name: Deploy to Vercel
        runs-on: ubuntu-latest
        needs: migrate

        steps:
            - uses: actions/checkout@v4

            - run: npm i -g vercel

            - run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
              env:
                  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
                  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

            - run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
              env:
                  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
                  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

            - run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
              env:
                  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
                  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
